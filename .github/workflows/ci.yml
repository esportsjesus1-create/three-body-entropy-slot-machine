name: CI

on:
  push:
    branches: [main, 'devin/**']
  pull_request:
    branches: [main]

jobs:
  lint-and-build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install root dependencies
        run: npm install

      - name: Build and test physics-engine
        working-directory: modules/physics-engine
        run: |
          npm install
          npm run build
          npm test -- --coverage

      - name: Build and test hash-chain
        working-directory: modules/hash-chain
        run: |
          npm install
          npm run build
          npm test -- --coverage

      - name: Build and test theta-protection
        working-directory: modules/theta-protection
        run: |
          npm install
          npm run build
          npm test -- --coverage

      - name: Build and test session-state-machine
        working-directory: modules/session-state-machine
        run: |
          npm install
          npm run build
          npm test -- --coverage

      - name: Build and test client-library
        working-directory: modules/client-library
        run: |
          npm install
          npm run build
          npm test -- --coverage

      - name: Build and test entropy-oracle
        working-directory: modules/entropy-oracle
        run: |
          npm install
          npm run build
          npm test -- --coverage

      - name: Build and test integration-examples
        working-directory: modules/integration-examples
        run: |
          npm install
          npm run build
          npm test -- --coverage

      - name: Run system integration tests
        working-directory: tests
        run: |
          npm install
          npm test

  coverage-report:
    runs-on: ubuntu-latest
    needs: lint-and-build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies and run coverage
        run: |
          npm install
          
          # Run coverage for each module
          for module in physics-engine hash-chain theta-protection session-state-machine client-library entropy-oracle integration-examples; do
            echo "Running coverage for $module"
            cd modules/$module
            npm install
            npm test -- --coverage --coverageReporters=text-summary || true
            cd ../..
          done

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: modules/*/coverage/
          retention-days: 7

  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Run npm audit
        run: |
          npm install
          npm audit --audit-level=high || true
          
          # Audit each module
          for module in physics-engine hash-chain theta-protection session-state-machine client-library entropy-oracle integration-examples; do
            echo "Auditing $module"
            cd modules/$module
            npm install
            npm audit --audit-level=high || true
            cd ../..
          done
